IMDb
----

*   O IMDb, ou "Internet Movie Database", tem conjuntos de dados [disponíveis para download](https://www.imdb.com/interfaces/) como arquivos de valores separados por tabulação (TSV).
*   Por exemplo, podemos baixar `title.basics.tsv.gz`, que conterá dados básicos sobre os títulos:
    *   `tconst`, um identificador único para cada título, como `tt4786824`
    *   `titleType`, o tipo de título, como `tvSeries`
    *   `primaryTitle`, o título principal usado, como `The Crown`
    *   `startYear`, o ano de lançamento do título, como `2016`
    *   `genres`, uma lista separada por vírgulas de gêneros, como `Drama,History`
*   Vamos dar uma olhada em `title.basics.tsv` depois de descompactá-lo e vemos que as primeiras linhas são realmente os cabeçalhos que esperávamos e cada linha possui valores separados por tabulação. Mas o arquivo tem mais de 6 milhões de linhas, então mesmo a busca por um valor leva um momento.
*   Vamos baixar o arquivo para o nosso IDE com `wget` e, em seguida, descompactá-lo com `gunzip`. Mas nosso IDE não tem espaço suficiente, então vamos usar o terminal do nosso Mac em vez disso.
*   Vamos escrever `import.py` para ler o arquivo:
    
        import csv
        
        # Abre arquivo TSV para leitura
        with open("title.basics.tsv", "r") as titles:
        
            # Como o arquivo é um arquivo TSV, podemos usar o leitor de CSV e alterar
            # o separador para uma tabulação.
            reader = csv.DictReader(titles, delimiter="\t")
        
            # Abre novo arquivo CSV para escrita
            with open("shows0.csv", "w") as shows:
        
                # Cria escritor
                writer = csv.writer(shows)
        
                # Escreve o cabeçalho das colunas que queremos
                writer.writerow(["tconst", "primaryTitle", "startYear", "genres"])
        
                # Percorre o arquivo TSV
                for row in reader:
        
                    # Se for uma série de TV para adultos
                    if row["titleType"] == "tvSeries" and row["isAdult"] == "0":
        
                        # Escreve a linha
                        writer.writerow([row["tconst"], row["primaryTitle"], row["startYear"], row["genres"]])
        
    
*   Agora, podemos abrir `shows0.csv` e ver um conjunto menor de dados. Mas acontece que, para algumas linhas, `startYear` tem um valor de `\N`, e esse é um valor especial do IMDb quando eles querem representar valores ausentes. Portanto, podemos filtrar esses valores e converter o `startYear` em um número inteiro para filtrar por programas após 1970:
    
        ...
        # Se o ano não estiver ausente (precisamos escapar a barra invertida também)
        if row["startYear"] != "\\N":
        
            # Se a partir de 1970
            if int(row["startYear"]) >= 1970:
        
                # Escreve a linha
                writer.writerow([row["tconst"], row["primaryTitle"], row["startYear"], row["genres"]])
        
    
*   Podemos escrever um programa para pesquisar por um título específico:
    
        import csv
        
        # Solicita ao usuário o título
        title = input("Título: ")
        
        # Abre arquivo CSV
        with open("shows2.csv", "r") as input:
        
            # Cria DictReader
            reader = csv.DictReader(input)
        
            # Percorre o arquivo CSV
            for row in reader:
        
                # Procura pelo título
                if title.lower() == row["primaryTitle"].lower():
                    print(row["primaryTitle"], row["startYear"], row["genres"], sep=" | ")
        
    
    *   Podemos executar esse programa e ver nossos resultados, mas podemos ver como o SQL pode fazer um trabalho melhor.
*   Em Python, podemos nos conectar a um banco de dados SQL e ler nosso arquivo nele uma vez, para que possamos fazer muitas consultas sem escrever novos programas e sem ter que ler o arquivo inteiro a cada vez.
*   Vamos fazer isso mais facilmente com a biblioteca CS50:
    
        import cs50
        import csv
        
        # Cria o banco de dados abrindo e fechando primeiro um arquivo vazio
        open(f"shows3.db", "w").close()
        db = cs50.SQL("sqlite:///shows3.db")
        
        # Cria uma tabela chamada `shows`, e especifica as colunas desejadas,
        # todas serão do tipo texto, exceto `startYear`
        db.execute("CREATE TABLE shows (tconst TEXT, primaryTitle TEXT, startYear NUMERIC, genres TEXT)")
        
        # Abre arquivo TSV
        # https://datasets.imdbws.com/title.basics.tsv.gz
        with open("title.basics.tsv", "r") as titles:
        
            # Cria DictReader
            reader = csv.DictReader(titles, delimiter="\t")
        
            # Percorre o arquivo TSV
            for row in reader:
        
                # Se for uma série de TV para adultos
                if row["titleType"] == "tvSeries" and row["isAdult"] == "0":
        
                    # Se o ano não estiver ausente
                    if row["startYear"] != "\\N":
        
                        # Se a partir de 1970
                        startYear = int(row["startYear"])
                        if startYear >= 1970:
        
                            # Insere o programa substituindo os valores em cada espaço reservado(?)
                            db.execute("INSERT INTO shows (tconst, primaryTitle, startYear, genres) VALUES(?, ?, ?, ?)",
                                       row["tconst"], row["primaryTitle"], startYear, genres)
        
    
*   Agora podemos executar `sqlite3 shows3.db` e executar comandos como antes, como `SELECT * FROM shows LIMIT 10;`.
*   Com `SELECT COUNT(*) FROM shows;` podemos ver que existem mais de 150.000 programas em nossa tabela, e com `SELECT COUNT(*) FROM shows WHERE startYear = 2019;`, vemos que houve mais de 6000 este ano.